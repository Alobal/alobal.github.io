<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="hphqb-Td3Fl9WUNX1Pj-X3Y9yfsqpQUnH4eP6eAqS7Q">
  <meta name="baidu-site-verification" content="codeva-9sj0MAnGdB">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sitchzou.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="参考Game Programming Patterns完成的设计模式总结笔记。 命令模式 命令模式本质上希望把一个硬编码的函数解耦成可配置的函数命令，尽可能将功能触发和具体功能分离。 如下有一个玩家对象的输入控制功能，其中按下X键对应jump动作。如果我们想要将X键绑定到fireGun功能，那还得去代码里修改对应的硬编码if语句，然后重新编译，重新链接。 1234567void Inpu">
<meta property="og:type" content="article">
<meta property="og:title" content="游戏中的代码设计模式总结">
<meta property="og:url" content="https://sitchzou.com/2023/07/12/%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="Sitch&#39;s Blog">
<meta property="og:description" content="参考Game Programming Patterns完成的设计模式总结笔记。 命令模式 命令模式本质上希望把一个硬编码的函数解耦成可配置的函数命令，尽可能将功能触发和具体功能分离。 如下有一个玩家对象的输入控制功能，其中按下X键对应jump动作。如果我们想要将X键绑定到fireGun功能，那还得去代码里修改对应的硬编码if语句，然后重新编译，重新链接。 1234567void Inpu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sitchzou.com/2023/07/12/%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/flyweight-tree-model.png">
<meta property="article:published_time" content="2023-07-12T13:38:54.000Z">
<meta property="article:modified_time" content="2023-07-12T13:38:54.000Z">
<meta property="article:author" content="Sitch">
<meta property="article:tag" content="设计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sitchzou.com/2023/07/12/%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/flyweight-tree-model.png">

<link rel="canonical" href="https://sitchzou.com/2023/07/12/%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>游戏中的代码设计模式总结 | Sitch's Blog</title>
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?13a5881f99caf50927823ae25a7cb3ee";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sitch's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-movies">

    <a href="/movies/" rel="section"><i class="fa fa-film fa-fw"></i>影片</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sitchzou.com/2023/07/12/%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Sitch">
      <meta itemprop="description" content="做好自己的现在">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sitch's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          游戏中的代码设计模式总结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-12 21:38:54" itemprop="dateCreated datePublished" datetime="2023-07-12T21:38:54+08:00">2023-07-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2023/07/12/%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/07/12/%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>参考<a target="_blank" rel="noopener" href="https://gpp.tkchu.me/">Game Programming
Patterns</a>完成的设计模式总结笔记。</p>
<h2 id="命令模式">命令模式</h2>
<p>命令模式本质上希望把一个<strong>硬编码的函数</strong>解耦成<strong>可配置的函数命令</strong>，尽可能将<strong>功能触发</strong>和<strong>具体功能</strong>分离。</p>
<p>如下有一个玩家对象的输入控制功能，其中按下X键对应jump动作。如果我们想要将X键绑定到fireGun功能，那还得去代码里修改对应的硬编码if语句，然后重新编译，重新链接。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputHandler::handleInput()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (isPressed(BUTTON_X)) jump();</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (isPressed(BUTTON_Y)) fireGun();</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (isPressed(BUTTON_A)) swapWeapon();</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (isPressed(BUTTON_B)) lurchIneffectively();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h3 id="动态绑定功能">动态绑定功能</h3>
<p>那么我们来将<strong>功能触发</strong>和<strong>具体功能</strong>分离吧。既然想要让X键对应动态的功能，那么可以用一个
多态/函数指针/委托
来实现。命令模式即使用多态方式，如下将jump,fireGun之类的功能抽取成一个<code>Command</code>基类的四个派生类，这样就可以通过<code>Command</code>对象的多态来实现动态绑定：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//基类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Command</span>() &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//功能类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JumpCommand</span> :</span> <span class="keyword">public</span> Command</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123; <span class="built_in">jump</span>(); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//功能类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FireCommand</span> :</span> <span class="keyword">public</span> Command</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123; <span class="built_in">fireGun</span>(); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接下来我们就可以为按键绑定功能，如buttonX_=FireCommand，然后在按键触发时动态执行虚函数就行了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InputHandler</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">handleInput</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  Command* buttonX_;</span><br><span class="line">  Command* buttonY_;</span><br><span class="line">  Command* buttonA_;</span><br><span class="line">  Command* buttonB_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InputHandler::handleInput</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isPressed</span>(BUTTON_X)) buttonX_-&gt;<span class="built_in">execute</span>();</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">isPressed</span>(BUTTON_Y)) buttonY_-&gt;<span class="built_in">execute</span>();</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">isPressed</span>(BUTTON_A)) buttonA_-&gt;<span class="built_in">execute</span>();</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">isPressed</span>(BUTTON_B)) buttonB_-&gt;<span class="built_in">execute</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们在游戏流程中随时可以根据需要来替换按键对应的功能。当然，动态绑定还可以带来其他的便利性，如我们可以把<code>Command.execute()</code>
改成
<code>Command.execute(GameObject actor)</code>,这样甚至能改变操作对象！</p>
<h3 id="撤销和重做">撤销和重做</h3>
<p>如上所述，功能的动态绑定可以通过 多态/函数指针/委托
三种方式来实现，但为什么命令模式选择了Command类与多态呢？实现成类，一方面可以便于添加扩展功能，另一方面类拥有状态信息，可以针对命令做一些维护操作，比如撤销和重做。</p>
<p>例如我们有一个Move
Command，在<code>execute()</code>中我们会移动角色，那么我们自然可以在Move中保留下角色移动之前的位置，然后构造一个<code>Undo()</code>操作，来将原来的位置赋值为角色，完成撤销。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoveUnitCommand</span> :</span> <span class="keyword">public</span> Command</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">MoveUnitCommand</span>(Unit* unit, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span><br><span class="line">  : <span class="built_in">unit_</span>(unit),</span><br><span class="line">    <span class="built_in">xBefore_</span>(<span class="number">0</span>),</span><br><span class="line">    <span class="built_in">yBefore_</span>(<span class="number">0</span>),</span><br><span class="line">    <span class="built_in">x_</span>(x),</span><br><span class="line">    <span class="built_in">y_</span>(y)</span><br><span class="line">  &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 保存移动之前的位置</span></span><br><span class="line">    <span class="comment">// 这样之后可以复原。</span></span><br><span class="line"></span><br><span class="line">    xBefore_ = unit_-&gt;<span class="built_in">x</span>();</span><br><span class="line">    yBefore_ = unit_-&gt;<span class="built_in">y</span>();</span><br><span class="line"></span><br><span class="line">    unit_-&gt;<span class="built_in">moveTo</span>(x_, y_);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">undo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    unit_-&gt;<span class="built_in">moveTo</span>(xBefore_, yBefore_);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  Unit* unit_;</span><br><span class="line">  <span class="keyword">int</span> xBefore_, yBefore_;</span><br><span class="line">  <span class="keyword">int</span> x_, y_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="享元模式">享元模式</h2>
<p>享元模式思路比较简单，就是把大量实例共享的那一部分数据单独抽取出来，成为一个共享数据<code>ShareData</code>类，并让其他实例类引用它即可。这样可以节省大量的内存，并且在GPU渲染大量同类实例时也能节省性能。</p>
<figure>
<img src="flyweight-tree-model.png"
alt="GPU渲染大量的树木时，可以把共享数据如网格、纹理等抽取出来引用，然后需要实例单独渲染的只有不同的位置了。" />
<figcaption
aria-hidden="true">GPU渲染大量的树木时，可以把共享数据如网格、纹理等抽取出来引用，然后需要实例单独渲染的只有不同的位置了。</figcaption>
</figure>
<h2 id="观察者模式">观察者模式</h2>
<p>观察者模式算是一种十分常用的模式了，即把数据的改动变化做成一个
<strong>事件</strong>，然后由
<strong>发布者</strong>发布该事件，<strong>订阅者</strong>则可以提前订阅好相关事件处理程序。每当数据改动时事件会被发布者Invoke，订阅者的事件处理程序即可响应执行。这在数据逻辑和UI分离的常规MVC开发模式下很常见。</p>
<p><strong>事件的订阅执行并没有想象中的那么慢</strong>：实际上在C#中事件就是由委托类型(类似函数指针)完成的。订阅者用事件处理程序去订阅事件通知，即相当于在事件的数据结构里保存这个事件处理程序的函数指针，每次事件的Invoke无非是遍历事件保存的函数指针数组依次执行而已。不过需要小心的一点是事件发布者可能会被订阅者阻塞，例如某个前端事件处理程序去访问网络...因此小心UI线程相关！</p>
<p><strong>对象销毁和垃圾处理</strong>：如上订阅者订阅事件时，发布者的内部其实是在引用订阅者对象。假如我们此时主动销毁了订阅者呢？那么事件Invoke时就会访问一个错误的野指针。所以订阅者需要注意在自己被释放时主动取消订阅。这个问题对垃圾回收语言有没有影响呢？C#中不需要主动销毁对象，因此倒不至于会得到一个野指针。但是由于发布者手握着一个引用，垃圾回收器只能认为订阅者对象是有用的，因此订阅者会一直存在于内存中，最终形成一种内存泄漏。更为严重的情况是，我们可能以为订阅者已经被回收了，之后又尝试加载一个新的订阅者示例，进行新的订阅，最终你的内存里可能有一万个订阅者！</p>
<blockquote>
<p>例如玩家在离开战斗场景时，我们可能会想要卸载战斗UI，但实际上由于事件订阅的存在，UI被隐藏后并没有被回收。而下一次玩家进入战斗场景时会创建新的战斗UI，现在，同样的UI就有两个了！之后还会有3个，4个....</p>
</blockquote>
<h2 id="单例模式">单例模式</h2>
<p>单例模式：一方面限定一个类只有一个示例，另一方面为这个实例提供了全局访问方式，示例如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">static</span> Singleton&amp; <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 惰性初始化</span></span><br><span class="line">    <span class="keyword">if</span> (instance_ == <span class="literal">NULL</span>) </span><br><span class="line">      instance_ = <span class="keyword">new</span> <span class="built_in">Singleton</span>();</span><br><span class="line">    <span class="keyword">return</span> *instance_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="built_in">Singleton</span>() &#123;&#125;</span><br><span class="line">  <span class="keyword">static</span> Singleton* instance_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看出单例模式实现十分简单，并且带来的好处显而易见：</p>
<ul>
<li><strong>全局直接访问</strong>：所有调用对象都无需存储相关引用和指针。99.9%的单例模式都是为了创建全局访问的Manager类。</li>
<li><strong>实例数量限定</strong>：避免不必要的重复。</li>
<li>惰性初始化实例：如果没有发生访问，则Singleton类永远不会创建实例。就算程序后期发生访问，那也是在运行时才实例化，不会给前期带来不必要的垃圾。</li>
<li>可动态实例化：这种全局访问的Manager类另一种类似的实现方法是<strong>C#的静态类</strong>，但是静态类很大的一个缺点就是初始化数据也只能是静态的。例如我不能写一个字段<code>static int a=ReadFromFile();</code>,而单例模式就没有这种动态依赖的困扰，想怎么初始化怎么初始化。</li>
<li>拥有类的完整特性，继承和多态：这样我们可以把一个单例基类扩展成多种泛化单例，分别添加不同的功能，之后再按需创建对应的一种。</li>
</ul>
<p>每个了解单例模式的人都能很快的上手使用，并且觉得这个模式真是又快又好。但是难道把所有类都往单例上怼就行了吗？就像从我们学编程开始就被教导不要乱用全局变量一样，比起学会使用单例，我们更需要关注有没有<strong>滥用全局单例</strong>：</p>
<ul>
<li>全局共享 =
<strong>类型安全降低</strong>：任何一个对单例的调用都可能对全局的数据进行更改。如果知道是哪个调用发生了错误的修改还好办，假如不知道是哪个调用呢？你开开心心的在单例的数据段打上断点，却发现这个单例会有几百次的相关调用，就算是007也很难从中找出错误的那一个。</li>
<li>全局访问 =
<strong>失去访问权限控制</strong>：增加耦合性。随便一个类，只要它想，就能在里面加上一笔单例的调用，导致代码的引用链简直乱七八糟，例如：逻辑功能
ref 音频单例 ref 物理单例 ref 渲染单例 ref
逻辑单例。有可能程序员只想做一个走路带声音的效果，但这段代码却把整个引擎系统都逛了一遍。之后维护的时候动了物理单例，可能音频单例就出错了，动了渲染单例，可能逻辑就跑出BUG了，失去了访问权限的控制，程序员不可能自觉的降低代码耦合。</li>
<li>实例数量限定 =
<strong>等等，我们真的需要单例的"单"吗？</strong>：正如上面所述，99.9%的单例模式都是为了全局访问，但我们往往就顺手给这个全局访问点加了个"限定唯一"的特性。我们真的需要唯一的访问点吗？好好想想。另一方面，当我们需要限定实例数量的时候，我们需要为它提供全局访问吗？换句话说，<strong>"全局"和"单例"有必要同时出现吗？</strong></li>
<li>惰性初始化 =
<strong>惰性加载还是预加载</strong>：在游戏开发中，预加载十分常见，有时候我们并不希望需要的时候再即时加载一个东西，而是希望提前在某个宽裕的点加载好。</li>
</ul>
<p>总而言之，比起把不方便访问的类一股脑的塞给单例模式，更优先想想是否需要<strong>全局变量</strong>，是否需要<strong>数量控制</strong>，如果是小范围的访问能不能用成员变量或者传递参数的方式解决？</p>
<h2 id="状态模式">状态模式</h2>
<p>让我们先从状态机的应用灵感讲起。在游戏中我们肯定会有一个角色控制器，其要控制玩家的
跳跃、卧倒、站立操作。当然，我们希望不能在空中无限跳跃，并且不能在空中卧倒等等...因此我们要在控制器中加入许多的判断条件检查是否允许操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Player::handleInput</span><span class="params">(Input input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (input == PRESS_B)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isJumping_ &amp;&amp; !isDucking_)<span class="comment">//跳跃之前需要检查 跳跃状态、卧倒状态</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 跳跃……</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (input == PRESS_DOWN)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isJumping_)<span class="comment">//卧倒之前需要检查 卧倒状态</span></span><br><span class="line">    &#123;</span><br><span class="line">      isDucking_ = <span class="literal">true</span>;</span><br><span class="line">      <span class="built_in">setGraphics</span>(IMAGE_DUCK);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (input == RELEASE_DOWN)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDucking_)<span class="comment">//站立之前需要检查卧倒</span></span><br><span class="line">    &#123;</span><br><span class="line">      isDucking_ = <span class="literal">false</span>;</span><br><span class="line">      <span class="built_in">setGraphics</span>(IMAGE_STAND);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="有限状态机的使用">有限状态机的使用</h3>
<p>可以看到光是 跳跃、卧倒、站立
这三个操作之间的互相耦合就已经非常难看了，如果还要加入攻击操作、道具操作、闪避操作等...可想而知代码中的<code>if</code>会爆炸式的增长，并且也根本理不清其中的避让关系。这时候就需要我们好好把所有的限定状态理清楚，迎接有限状态机的救援
(这里不细谈有限状态机的基本定义)：</p>
<figure>
<img
src="%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/state-flowchart.png"
alt="有限状态机" />
<figcaption aria-hidden="true">有限状态机</figcaption>
</figure>
<p>这个时候我们需要顾虑的事情就变了：</p>
<ul>
<li>之前的担忧：进入下一个操作前，需要检查不能从什么操作转移过来
(禁止父操作)，比如 跳跃 之前不能在 攻击、下蹲、喝药...。</li>
<li>现在的考量：在当前操作状态中，需要检查能去往什么操作状态
(可行子操作)。比如 跳跃 能去往 跳斩。</li>
</ul>
<p>通常情况下对于一个操作状态来说，它的 可行子操作 肯定比 禁止父操作
要多得多。如图中 跳斩 没有去往的操作状态，但是不能前往 跳斩 的操作有
蹲下、站立，而且随着状态的增加，禁止父操作会O(N)级别增长，而可行子操作往往变化不大。因此，在通过状态机转换思考方式之后，我们需要考虑的条件明显简化了很多。那么我们怎么来实现这个状态机呢？首先需要定义所有的<strong>状态</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">State</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  STATE_STANDING,</span><br><span class="line">  STATE_JUMPING,</span><br><span class="line">  STATE_DUCKING,</span><br><span class="line">  STATE_DIVING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后根据我们的状态图，可以定义出每个状态的状态转移操作，朴素点的话可以用<code>if</code>来实现条件判断：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Player::handleInput</span><span class="params">(Input input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (state_)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> STATE_STANDING:</span><br><span class="line">            <span class="keyword">if</span> (input == PRESS_B)</span><br><span class="line">            &#123;</span><br><span class="line">              state_ = STATE_JUMPING;</span><br><span class="line">              <span class="built_in">setGraphics</span>(jump_image);</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (input == PRESS_DOWN)</span><br><span class="line">            &#123;</span><br><span class="line">              state_ = STATE_DUCKING;</span><br><span class="line">              <span class="built_in">setGraphics</span>(duck_image);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> STATE_JUMPING:</span><br><span class="line">            <span class="keyword">if</span> (input == PRESS_DOWN)</span><br><span class="line">            &#123;</span><br><span class="line">              state_ = STATE_DIVING;</span><br><span class="line">              <span class="built_in">setGraphics</span>(dive_image);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> STATE_DUCKING:</span><br><span class="line">            <span class="keyword">if</span> (input == RELEASE_DOWN)</span><br><span class="line">            &#123;</span><br><span class="line">              state_ = STATE_STANDING;</span><br><span class="line">              <span class="built_in">setGraphics</span>(stand_image);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这已经完成了状态机的模型，但还差了点意思。这里每个状态只是用一个枚举以及switch的分支来决定，但其实所有的状态还是在共享着Player的所有数据段。因此假如我们要为每个运动设置一个持续时间，那么我们就要往Player里塞4个time数据。并且对于其中一个状态来说，有3个time数据是和它没任何关系的。为了优化这一点，我们可以很自然的想到<strong>用派生类来表示状态</strong>：</p>
<p>首先定义一个状态基类，其定义了每个状态的基本操作，例如进入状态时操作、退出状态时操作、帧更新、接受输入：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlayerState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">PlayerState</span>() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">enter</span><span class="params">(Player&amp; player)</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">exit</span><span class="params">(Player&amp; player)</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">handleInput</span><span class="params">(Player&amp; player, Input input)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Player&amp; player)</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后定义具体的状态类：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DuckingState</span> :</span> <span class="keyword">public</span> PlayerState</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DuckingState</span>(): <span class="built_in">chargeTime_</span>(<span class="number">0</span>)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">enter</span><span class="params">(Player&amp; player)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        player.<span class="built_in">setGraphics</span>(duck_image)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回值用于告诉父级是否需要切换状态</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> PlayerState* <span class="title">handleInput</span><span class="params">(Player&amp; player, Input input)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == RELEASE_DOWN)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">StandState</span>();<span class="comment">//返回新状态用于切换</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;<span class="comment">//返回空则说明没有新状态，不用切换</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Player&amp; player)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        chargeTime_++;</span><br><span class="line">        <span class="keyword">if</span> (chargeTime_ &gt; MAX_CHARGE)</span><br><span class="line">        &#123;</span><br><span class="line">            player.<span class="built_in">superBomb</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> chargeTime_;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这时候每个状态会管理好自己的转移操作，并且我们还可以为每个状态单独添加其专属的数据字段，如<code>chargeTime_</code>。并且在<code>Player</code>中对状态的处理也可以利用多态来简化：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">handleInput</span><span class="params">(Input input)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        PlayerState* new_state=state-&gt;<span class="built_in">handleInput</span>(*<span class="keyword">this</span>, input);</span><br><span class="line">        <span class="keyword">if</span>(new_state!=<span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">delete</span> state;</span><br><span class="line">            state=new_state;</span><br><span class="line">            state-&gt;<span class="built_in">enter</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      state-&gt;<span class="built_in">update</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 其他方法……</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    PlayerState* state;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>有限状态机已经很棒了，它帮我们把复杂的判断条件全部梳理了出来，整个系统变得从所未有的干净整洁！但是如果你用过Unity的动画机就知道，仅仅是一个的有限状态机只能表示一张连通的状态图，但实际中我们还会有很多不相关的状态，并不是所有图都是连通图不是吗？</p>
<h3 id="多个并行的状态机">多个并行的状态机</h3>
<p>例如我们现在已经掌握了Player的所有角色动作，我们还想要增加一个 持枪
的状态，持枪和之前的
跳跃、蹲下、站立都没关系，无论在什么姿势都能在Player的手上加上这把枪。那我们该怎么判断呢？如果只用一个状态机，那我们难道要直接增加一倍的状态：持枪跳跃、持枪蹲下、持枪站立？这样显然及其低效且繁琐。因此我们可以为持枪创建一个独立的状态机，即让Player拥有两个并行状态判断：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Heroine::handleInput</span><span class="params">(Input input)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    action_state-&gt;<span class="built_in">handleInput</span>(*<span class="keyword">this</span>, input);</span><br><span class="line">    equip_state-&gt;<span class="built_in">handleInput</span>(*<span class="keyword">this</span>, input);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    PlayerState* action_state;</span><br><span class="line">    PlayerState* equip_state;</span><br></pre></td></tr></table></figure>
<p>这时候在action_state里开个小的<code>if</code>分支判断equip_state的状态接口。例如equip_state处于不持枪时则保持jump_image,
持枪则改为jump_and_gun_image。当然这样又回到了使用状态机之前的<code>if</code>地狱，只不过规模小了一点，可以称为<code>if</code>地牢。</p>
<h3 id="分层状态机">分层状态机</h3>
<p>再来考虑复用/继承状态机的事情。例如在Player站立、跳跃时，我们要允许其进行开火操作：生成子弹、生成粒子效果、生成音效...我们显然不能在Player中实现<code>Fire()</code>操作，因为这样那些禁止开火的状态也能调用这个功能了，因此我们得在允许开火的状态内实现。在最粗暴的时候，我们会为站立、跳跃状态都粘贴<code>Fire()</code>操作，但这样显然不利于维护，我们希望<code>Fire()</code>的代码能够在多个状态机之间复用。因此按照我们平常面向对象的思路，我们可以抽取出一个
允许开火
的基类状态，把<code>Fire()</code>实现在里面，再让站立、跳跃的状态继承它。这就是分层状态机的结构。</p>
<h3 id="下推状态机">下推状态机</h3>
<p>下推状态机即为状态机加上历史记录功能。例如我们允许Player进行喝药补血，它可以蹲着喝也可以站着喝(喝药是一个持续性的动作，因此我们把它当做<strong>状态</strong>而不是<strong>操作</strong>)，但是我们不希望它蹲着喝完就自动站起来了，或者站着喝完就自动蹲下了。我们需要记录其在进入喝药状态之前的状态，显然我们需要维护一个状态栈来表示状态的历史记录。这就是下推状态机。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%AE%BE%E8%AE%A1/" rel="tag"># 设计</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/07/07/%E6%96%87%E7%AB%A0%E6%94%B6%E8%97%8F/" rel="prev" title="文章收藏">
      <i class="fa fa-chevron-left"></i> 文章收藏
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.</span> <span class="nav-text">命令模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E7%BB%91%E5%AE%9A%E5%8A%9F%E8%83%BD"><span class="nav-number">1.1.</span> <span class="nav-text">动态绑定功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%92%A4%E9%94%80%E5%92%8C%E9%87%8D%E5%81%9A"><span class="nav-number">1.2.</span> <span class="nav-text">撤销和重做</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.</span> <span class="nav-text">享元模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.</span> <span class="nav-text">观察者模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F"><span class="nav-number">4.</span> <span class="nav-text">单例模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.</span> <span class="nav-text">状态模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">5.1.</span> <span class="nav-text">有限状态机的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E5%B9%B6%E8%A1%8C%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">5.2.</span> <span class="nav-text">多个并行的状态机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B1%82%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">5.3.</span> <span class="nav-text">分层状态机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E6%8E%A8%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-number">5.4.</span> <span class="nav-text">下推状态机</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sitch"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Sitch</p>
  <div class="site-description" itemprop="description">做好自己的现在</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">123</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/alobal" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;alobal" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:778377698@qq.com" title="E-Mail → mailto:778377698@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://steamcommunity.com/id/sitchzou/" title="Steam → https:&#x2F;&#x2F;steamcommunity.com&#x2F;id&#x2F;sitchzou&#x2F;" rel="noopener" target="_blank"><i class="fab fa-steam fa-fw"></i>Steam</a>
      </span>
  </div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sitch</span>
</div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
// var pjax = new Pjax({
//   selectors: [
//     'head title',
//     '#page-configurations',
//     '.content-wrap',
//     '.post-toc-wrap',
//     '.languages',
//     '#pjax'
//   ],
//   switches: {
//     '.post-toc-wrap': Pjax.switches.innerHTML
//   },
//   analytics: false,
//   cacheBust: false,
//   scrollTo : !CONFIG.bookmark.enable
// });

// window.addEventListener('pjax:success', () => {
//   document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
//     var code = element.text || element.textContent || element.innerHTML || '';
//     var parent = element.parentNode;
//     parent.removeChild(element);
//     var script = document.createElement('script');
//     if (element.id) {
//       script.id = element.id;
//     }
//     if (element.className) {
//       script.className = element.className;
//     }
//     if (element.type) {
//       script.type = element.type;
//     }
//     if (element.src) {
//       script.src = element.src;
//       // Force synchronous loading of peripheral JS.
//       script.async = false;
//     }
//     if (element.dataset.pjax !== undefined) {
//       script.dataset.pjax = '';
//     }
//     if (code !== '') {
//       script.appendChild(document.createTextNode(code));
//     }
//     parent.appendChild(script);
//   });
//   NexT.boot.refresh();
//   // Define Motion Sequence & Bootstrap Motion.
//   if (CONFIG.motion.enable) {
//     NexT.motion.integrator
//       .init()
//       .add(NexT.motion.middleWares.subMenu)
//       .add(NexT.motion.middleWares.postList)
//       .bootstrap();
//   }
//   NexT.utils.updateSidebarPosition();
// });
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'PcR31yj1TEn6z0UqyTXNP6NN-gzGzoHsz',
      appKey     : 'LEQbv9t6GJ3BAdMOMXDh0blJ',
      placeholder: "【留言板】  欢迎用你的脸滚一滚键盘~\n支持markdown语法,没有邮件提醒可能回复稍慢，抱歉~\n",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : 'https://pcr31yj1.lc-cn-n1-shared.com'
    });
  }, window.Valine);
});
</script>

    </div>


</html>

<!--崩溃欺骗-->


